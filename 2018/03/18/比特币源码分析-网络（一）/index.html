<!DOCTYPE html>
<html class="full-height">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="//cdn.bootcss.com/bulma/0.4.1/css/bulma.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  
  <title>比特币源码分析-网络（一） | Cryptocurrency Tech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在梳理代码逻辑之前，首先介绍几个比较重要的结构： CMessageHeader消息头包含的内容： 123456789101112131415class CMessageHeader &amp;#123;public:    enum &amp;#123;        MESSAGE_START_SIZE = 4,        //消息开始字符串，长度4字节，就是告诉你是属于哪种消息标识，在UTF-8中无效">
<meta name="keywords" content="Bitcoin">
<meta property="og:type" content="article">
<meta property="og:title" content="比特币源码分析-网络（一）">
<meta property="og:url" content="http://yoursite.com/2018/03/18/比特币源码分析-网络（一）/index.html">
<meta property="og:site_name" content="Cryptocurrency Tech">
<meta property="og:description" content="在梳理代码逻辑之前，首先介绍几个比较重要的结构： CMessageHeader消息头包含的内容： 123456789101112131415class CMessageHeader &amp;#123;public:    enum &amp;#123;        MESSAGE_START_SIZE = 4,        //消息开始字符串，长度4字节，就是告诉你是属于哪种消息标识，在UTF-8中无效">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/6967649-10baa6a49bc59f03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/6967649-4793d9bd4f6631cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2018-03-18T11:07:17.120Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="比特币源码分析-网络（一）">
<meta name="twitter:description" content="在梳理代码逻辑之前，首先介绍几个比较重要的结构： CMessageHeader消息头包含的内容： 123456789101112131415class CMessageHeader &amp;#123;public:    enum &amp;#123;        MESSAGE_START_SIZE = 4,        //消息开始字符串，长度4字节，就是告诉你是属于哪种消息标识，在UTF-8中无效">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/6967649-10baa6a49bc59f03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
  
    <link rel="alternate" href="/atom.xml" title="Cryptocurrency Tech" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/css/nav.css">
<link rel="stylesheet" href="/css/layout.css">
  

</head>

<body>
  <header id="navbar" class="overflow-hidden">
  <div class="container">
    <nav class="nav">
         <div class="nav-left">
            <a href="/" class="nav-item" style="font-size: 20px;">
              <span class="logo">Copernicus</span>'s Blog
            </a>
         </div>
        <div class="nav-center is-hidden position-relative" id="search_container">
            <div class="nav-item full-width full-height">
                <i class="fa fa-search has-padding" aria-hidden="true"></i>
                <input type="text" id="search_input" class="search-input full-height full-width" placeholder="Search post" autofocus>
                <i id="close_search" class="fa fa-times" aria-hidden="true"></i>
            </div>
            <div id="search_result"></div>
        </div>
        <div class="nav-right nav-menu">
            <a class="nav-item" id="search">
                <i class="fa fa-search" aria-hidden="true"></i>
            </a>
            
            <a class="nav-item" href="/">
                Home
            </a>
            
            <a class="nav-item" href="/works">
                My Works
            </a>
            
            <a class="nav-item" href="/about">
                About
            </a>
            
        </div>
        <span class="nav-toggle" id="navMenuDropdown">
            <span></span>
            <span></span>
            <span></span>
        </span>
        <div class="navbar-menu position-absolute full-width content-box is-hidden-desktop is-flex flex-column center" style="top: 100%;">
            
            <a class="nav-item flex-1" href="/">
                Home
            </a>
            
            <a class="nav-item flex-1" href="/works">
                My Works
            </a>
            
            <a class="nav-item flex-1" href="/about">
                About
            </a>
            
        </div>
    </nav>
  </div>
</header>

  <div id="main-wrap" class="position-relative" style="margin-top: 55px;">
      <div class="main-inner-content">
          <!--博文页面-->

<style>
    .header-box {
        height: 370px;
        filter: blur(10px);
        background-size: cover;
        background-color: lightsteelblue;
    }

    .post-box {
        padding: 15px;
        padding-top: 60px;
        min-height: 80vh;
        margin-top: -200px;
        border-radius: 4px;
        background-color: rgba(255,255,255,.8);
    }

    .post-avatar {
        height: 30px;
        width: 30px;
        border-radius: 50%;
    }

    .flow-chart {
        text-align: center;
    }

    img[alt="post-cover"] {
        display: none;
    }
</style>
<header>
    <div id="header_box" class="header-box"></div>
</header>
<section>
    <div class="container post-box">
        <div class="content post-title is-flex center flex-column" style="margin-bottom: 70px; overflow: auto;">
            <h1 class="has-text-centered" style="padding-bottom: 10px; border-bottom: 3px solid #fff">
                <strong>比特币源码分析-网络（一）</strong>
            </h1>
            
            <div class="is-flex align-center">
                <img class="post-avatar" src="https://cdn2.iconfinder.com/data/icons/rcons-user/32/male-shadow-circle-512.png">
                <span style="padding:0 10px;"> <span class="sub-title">By</span> Copernicus</span>
                <span class="post-date sub-title">at: 2018-03-18</span>
            </div>
            
                <div>
                    
                         <a class="tag is-post-tag" href="/tags/Bitcoin/">Bitcoin</a>
                    
                </div>
            
        </div>
        <div class="content" style="overflow: auto">
            <p>在梳理代码逻辑之前，首先介绍几个比较重要的结构：</p>
<h3 id="CMessageHeader"><a href="#CMessageHeader" class="headerlink" title="CMessageHeader"></a>CMessageHeader</h3><p>消息头包含的内容：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CMessageHeader</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        MESSAGE_START_SIZE = <span class="number">4</span>,</span><br><span class="line">        <span class="comment">//消息开始字符串，长度4字节，就是告诉你是属于哪种消息标识，在UTF-8中无效</span></span><br><span class="line">        <span class="comment">//主类型（MAIN）：   0xd9b4bef9</span></span><br><span class="line">        <span class="comment">//测试网络(TESTNET)：0x0709110b</span></span><br><span class="line">        <span class="comment">//回归测试(REGTEST)：0xdab6bffa</span></span><br><span class="line">        COMMAND_SIZE = <span class="number">12</span>,</span><br><span class="line">        <span class="comment">//定义了通信中的各种命令，由0x20~0x7F之间的字 符串构成，</span></span><br><span class="line">        MESSAGE_SIZE_SIZE = <span class="number">4</span>,</span><br><span class="line">        <span class="comment">//最大值是32M (0x02000000)。 不包含消息头的大小</span></span><br><span class="line">        CHECKSUM_SIZE = <span class="number">4</span>,</span><br><span class="line">        <span class="comment">//把消息数据经过2次SHA256算法运算得到校验和</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Message-Headers"><a href="#Message-Headers" class="headerlink" title="Message Headers"></a>Message Headers</h3><p><em>网络传输中，所有消息的消息头格式是一样的，下面解释一下每一个消息头具体包含哪些内容：</em></p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td><a href="https://bitcoin.org/en/glossary/start-string" title="Four defined bytes which start every message in the Bitcoin P2P protocol to allow seeking to the next message." target="_blank" rel="noopener">start string</a></td>
<td>char[4]</td>
<td>告诉发送端的节点，现在可以开始发送 Magic 的消息;用于在流状态未知时寻求下一条消息。</td>
</tr>
<tr>
<td>12</td>
<td>command name</td>
<td>char[12]</td>
<td>标识有效载荷中包含的消息类型的ASCII字符串。随后是空值（0x00）来填充字节数; 例如：<code>version\0\0\0\0\0</code></td>
</tr>
<tr>
<td>4</td>
<td>payload size</td>
<td>uint32_t</td>
<td>有效 payload 中的字节数。Bitcoin Core 在有效的 payload 中允许的当前最大字节数（MAX_SIZE）为32个有效载荷大小超过此值的消息将被丢弃或拒绝。</td>
</tr>
<tr>
<td>4</td>
<td>checksum</td>
<td>char[4]</td>
<td>SHA256的前4个字节（SHA256（payload））以内部字节顺序排列。 如果有效payload为空，如verack和getaddr消息，则校验和始终为0x5df6e0e2（SHA256（SHA256（<empty string="">））</empty></td>
</tr>
</tbody>
</table>
<h3 id="GetDataMsg"><a href="#GetDataMsg" class="headerlink" title="GetDataMsg"></a>GetDataMsg</h3><p>getdata / inv消息类型。这些号码由协议定义。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">enum GetDataMsg &#123;</span><br><span class="line">    UNDEFINED = 0,</span><br><span class="line">    MSG_TX = 1,</span><br><span class="line">    MSG_BLOCK = 2,</span><br><span class="line">    // The following can only occur in getdata. Invs always use TX or BLOCK.</span><br><span class="line">    //!&lt; Defined in BIP37</span><br><span class="line">    MSG_FILTERED_BLOCK = 3,</span><br><span class="line">    //!&lt; Defined in BIP152</span><br><span class="line">    MSG_CMPCT_BLOCK = 4,</span><br><span class="line"></span><br><span class="line">    //!&lt; Extension block</span><br><span class="line">    MSG_EXT_TX = MSG_TX | MSG_EXT_FLAG,</span><br><span class="line">    MSG_EXT_BLOCK = MSG_BLOCK | MSG_EXT_FLAG,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>消息类型大致分为：</p>
<ol>
<li>MSG_TX              交易信息</li>
<li>MSG_BLOCK           区块</li>
<li>MSG_FILTERED_BLOCK  过滤的区块</li>
<li>MSG_CMPCT_BLOCK    紧凑区块  //bip152</li>
</ol>
<h2 id="NetMsgType"><a href="#NetMsgType" class="headerlink" title="NetMsgType"></a>NetMsgType</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> NetMsgType &#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *VERSION = <span class="string">"version"</span>;<span class="comment">//获取版本信息</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *VERACK = <span class="string">"verack"</span>;<span class="comment">//版本信息回应</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *ADDR = <span class="string">"addr"</span>;<span class="comment">//网络节点的地址</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *INV = <span class="string">"inv"</span>;<span class="comment">//库存清单</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *GETDATA = <span class="string">"getdata"</span>;<span class="comment">//获取数据</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *MERKLEBLOCK = <span class="string">"merkleblock"</span>;<span class="comment">//merkle块</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *GETBLOCKS = <span class="string">"getblocks"</span>;<span class="comment">//获取区块</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *GETHEADERS = <span class="string">"getheaders"</span>;<span class="comment">//获取区块头</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *TX = <span class="string">"tx"</span>;<span class="comment">//交易信息</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *HEADERS = <span class="string">"headers"</span>;<span class="comment">//区块头</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *BLOCK = <span class="string">"block"</span>;<span class="comment">//区块</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *GETADDR = <span class="string">"getaddr"</span>;<span class="comment">//获取地址</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *MEMPOOL = <span class="string">"mempool"</span>;<span class="comment">//内存池</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *PING = <span class="string">"ping"</span>;<span class="comment">//判断网络是否连通</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *PONG = <span class="string">"pong"</span>;<span class="comment">//ping消息回应</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *NOTFOUND = <span class="string">"notfound"</span>;<span class="comment">//没有获取相匹配的数据</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *FILTERLOAD = <span class="string">"filterload"</span>;<span class="comment">//加载过滤器</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *FILTERADD = <span class="string">"filteradd"</span>;<span class="comment">//添加过滤交易信息</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *FILTERCLEAR = <span class="string">"filterclear"</span>;<span class="comment">//清理过滤器</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *REJECT = <span class="string">"reject"</span>;<span class="comment">//拒绝</span></span><br><span class="line">	<span class="comment">//======================网络协议版本号为70002之前======================//</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *SENDHEADERS = <span class="string">"sendheaders"</span>; <span class="comment">//bip130 发送块头信息</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *FEEFILTER = <span class="string">"feefilter"</span>;<span class="comment">//BIP133 feefilter</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *SENDCMPCT = <span class="string">"sendcmpct"</span>;<span class="comment">// BIP152 发送紧凑区块</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *CMPCTBLOCK = <span class="string">"cmpctblock"</span>;<span class="comment">// BIP152 紧凑区块</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *GETBLOCKTXN = <span class="string">"getblocktxn"</span>;<span class="comment">// BIP152 获取紧凑区块交易</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *BLOCKTXN = <span class="string">"blocktxn"</span>;<span class="comment">// BIP152 紧凑区块交易</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Inv"><a href="#Inv" class="headerlink" title="Inv"></a>Inv</h2><p>当需要获取<code>inventory</code>时，发送此命令，发送时，需要指定范围。接收到此命令后，按指定范围获取inventory数据(PushGetBlocks)。</p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Varies</td>
<td>count</td>
<td>compactSize uint</td>
<td>inventory 条目的数量</td>
</tr>
<tr>
<td>Varies</td>
<td>inventory</td>
<td>inventory</td>
<td>一个或多个库存条目，最多50,000个条目</td>
</tr>
</tbody>
</table>
<p>Inv 消息的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">02 ................................. Count: 2</span><br><span class="line"></span><br><span class="line">01000000 ........................... Type: MSG_TX</span><br><span class="line">de55ffd709ac1f5dc509a0925d0b1fc4</span><br><span class="line">42ca034f224732e429081da1b621f55a ... Hash (TXID)</span><br><span class="line"></span><br><span class="line">01000000 ........................... Type: MSG_TX</span><br><span class="line">91d36d997037e08018262978766f24b8</span><br><span class="line">a055aaf1d872e94ae85e9817b2c68dc7 ... Hash (TXID)</span><br></pre></td></tr></table></figure>
<h3 id="getdata："><a href="#getdata：" class="headerlink" title="getdata："></a>getdata：</h3><p>getdata消息请求来自另一个节点的一个或多个数据对象。这些对象由一个 inventory 请求，请求节点通常通过inv消息预先接收这些对象。</p>
<p>对 getdata 消息的响应可以是 tx 消息，阻塞消息，merkleblock 消息或未找到的消息。</p>
<p>getdata 不能用于请求任意数据，例如不再存在于内存池中的一些历史交易。如果全节点已经从其block数据库中打包了先前的交易，这时全节点可能无法提供这些block。 出于这个原因，getdata消息通常只能通过发送inv消息向先前通告它的节点请求数据。</p>
<p>getdata消息的格式和最大大小限制与inv消息相同，但是消息标题不同。</p>
<h3 id="merkleblock："><a href="#merkleblock：" class="headerlink" title="merkleblock："></a>merkleblock：</h3><p>如BIP37所述，在协议版本70001中添加。</p>
<p>merkleblock 消息是对使用 inventory 类型 MSG_MERKLEBLOCK 请求块的 getdata 消息的回复。这只是答复的一部分：如果找到任何匹配的交易，它们将作为tx消息单独发送。</p>
<p>如果之前已经使用过滤器加载消息设置了过滤器，则merkleblock消息将包含所请求块中与过滤器匹配的所有事务的TXID以及将这些事务连接到块头的必要块所需的块merkle树的任何部分 merkle根。 该消息还包含块头的完整副本，以允许客户端对其进行 hash 并确认其工作证明。</p>
<p>merkleblock消息示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">01000000 ........................... Block version: 1</span><br><span class="line">82bb869cf3a793432a66e826e05a6fc3</span><br><span class="line">7469f8efb7421dc88067010000000000 ... Hash of previous block&apos;s header</span><br><span class="line">7f16c5962e8bd963659c793ce370d95f</span><br><span class="line">093bc7e367117b3c30c1f8fdd0d97287 ... Merkle root</span><br><span class="line">76381b4d ........................... Time: 1293629558</span><br><span class="line">4c86041b ........................... nBits: 0x04864c * 256**(0x1b-3)</span><br><span class="line">554b8529 ........................... Nonce</span><br><span class="line"></span><br><span class="line">07000000 ........................... Transaction count: 7</span><br><span class="line">04 ................................. Hash count: 4</span><br><span class="line"></span><br><span class="line">3612262624047ee87660be1a707519a4</span><br><span class="line">43b1c1ce3d248cbfc6c15870f6c5daa2 ... Hash #1</span><br><span class="line">019f5b01d4195ecbc9398fbf3c3b1fa9</span><br><span class="line">bb3183301d7a1fb3bd174fcfa40a2b65 ... Hash #2</span><br><span class="line">41ed70551dd7e841883ab8f0b16bf041</span><br><span class="line">76b7d1480e4f0af9f3d4c3595768d068 ... Hash #3</span><br><span class="line">20d2a7bc994987302e5b1ac80fc425fe</span><br><span class="line">25f8b63169ea78e68fbaaefa59379bbf ... Hash #4</span><br><span class="line"></span><br><span class="line">01 ................................. Flag bytes: 1</span><br><span class="line">1d ................................. Flags: 1 0 1 1 1 0 0 0</span><br></pre></td></tr></table></figure>
<h3 id="getblocks"><a href="#getblocks" class="headerlink" title="getblocks"></a>getblocks</h3><p>getblocks消息请求一个inv消息，该消息提供从块链中的特定点开始的块头hash。区块同步时，发送此命令，发送时需要指定区块范围(PushGetBlocks)。接收到此命令后，根据区块范围，获取相应的区块，反馈回去。接收的数据中包含区块范围的开始区块的定位信息(CBlockLocator)、结束区块的索引，从开始区块的下一个区块开始。每次最多获取500个区块信息。满500个时，记录获取的最后一个区块的hahs值，保存到源节点的hashContinue中。</p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>version</td>
<td>uint32_t</td>
<td>协议版本号;与版本信息中发送的一样。</td>
</tr>
<tr>
<td>Varies</td>
<td>hash count</td>
<td>compactSize uint</td>
<td>提供的header数量不包括stop哈希。除了整个消息的字节大小必须低于MAX_SIZE限制外，没有限制;通常发送1到200次hash。</td>
</tr>
<tr>
<td>Varies</td>
<td>block header hashes</td>
<td>char[32]</td>
<td>一个或多个块头hash（每个32字节）以内部字节顺序排列。hash应该以块高度相反的顺序提供，因此最高高度 hash 指向第一个，最低高度哈希指向最后一个。</td>
</tr>
<tr>
<td>32</td>
<td>stop hash</td>
<td>char[32]</td>
<td>请求最后一个header hash 的头部hash值; 设置为全零以请求包含所有后续头部hash的inv消息（最多500个将作为对此消息的回复发送;如果您需要超过500个，则需要发送另一个具有更高高度头部的getblocks消息 hash 作为块头 hash 字段中的第一个条目）。</td>
</tr>
</tbody>
</table>
<p>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">71110100 ........................... Protocol version: 70001</span><br><span class="line">02 ................................. Hash count: 2</span><br><span class="line"></span><br><span class="line">d39f608a7775b537729884d4e6633bb2</span><br><span class="line">105e55a16a14d31b0000000000000000 ... Hash #1</span><br><span class="line"></span><br><span class="line">5c3e6403d40837110a2e8afb602b1c01</span><br><span class="line">714bda7ce23bea0a0000000000000000 ... Hash #2</span><br><span class="line"></span><br><span class="line">00000000000000000000000000000000</span><br><span class="line">00000000000000000000000000000000 ... Stop hash</span><br></pre></td></tr></table></figure>
<h3 id="getheaders"><a href="#getheaders" class="headerlink" title="getheaders"></a>getheaders</h3><p>getheaders消息请求 headers 消息，该消息提供从块链中的特定点开始的块 header。接收到此命令后，获取指定的范围的区块的头，将 headers消息发送给源节点。</p>
<p>getheaders消息几乎与getblocks消息相同，只有一点区别：对getblocks消息的inv回复将包含不超过500个块头hash; headers 回复 getheaders 消息将包含多达2000个块 headers。</p>
<h3 id="tx"><a href="#tx" class="headerlink" title="tx"></a>tx</h3><p>tx 消息以原始交易格式传输单个交易。它可以在各种情况下发送;</p>
<ul>
<li>交易响应：Bitcoin Core 和 BitcoinJ 将发送它以响应getdata消息，该消息请求 inventory 类型为MSG_TX的交易。</li>
<li>MerkleBlock响应：Bitcoin Core 将发送它以响应getdata消息，该消息请求inventory类型为MSG_MERKLEBLOCK的merkle块。 （这是发送merkleblock消息的补充。）在这种情况下，每个tx消息提供该块的匹配交易。</li>
<li>Unsolicited：BitcoinJ会发送一个tx消息来主动发起它的交易。</li>
</ul>
<h3 id="headers"><a href="#headers" class="headerlink" title="headers"></a>headers</h3><p>headers 消息将 block message 发送到先前用getheaders消息请求特定 headers 的节点。headers 消息可以是空的。</p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Varies</td>
<td>count</td>
<td>compactSize uint</td>
<td>block headers 的数量最多可达200​​0个。注意：headers-first sync 假定发送节点将尽可能发送最大数量的headers</td>
</tr>
<tr>
<td>Varies</td>
<td>headers</td>
<td>block_header</td>
<td>block headers：每个80字节block headers采用 block headers section中描述的格式，并附加一个0x00后缀。 这个0x00被称为交易计数器，但由于头部消息不包含任何事务，因此事务计数始终为零。</td>
</tr>
</tbody>
</table>
<p>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">01 ................................. Header count: 1</span><br><span class="line"></span><br><span class="line">02000000 ........................... Block version: 2</span><br><span class="line">b6ff0b1b1680a2862a30ca44d346d9e8</span><br><span class="line">910d334beb48ca0c0000000000000000 ... Hash of previous block&apos;s header</span><br><span class="line">9d10aa52ee949386ca9385695f04ede2</span><br><span class="line">70dda20810decd12bc9b048aaab31471 ... Merkle root</span><br><span class="line">24d95a54 ........................... Unix time: 1415239972</span><br><span class="line">30c31b18 ........................... Target (bits)</span><br><span class="line">fe9f0864 ........................... Nonce</span><br><span class="line"></span><br><span class="line">00 ................................. Transaction count (0x00)</span><br></pre></td></tr></table></figure>
<h3 id="block"><a href="#block" class="headerlink" title="block"></a>block</h3><p>block message以 serialized blocks section 描述的格式发送单个 serialized block。</p>
<ol>
<li>获取数据响应：节点将始终发送它以响应一个getdata消息，该消息请求存储类型为MSG_BLOCK的块（假设该节点具有可用于发送的该块）。</li>
<li>主动提供：一些矿工会发送未经请求的block信息，将他们新挖掘的块块广播给他们的所有同行。 许多矿池做同样的事情，虽然有些可能被错误地配置为从多个节点发送块，可能不止一次地将同一块发送给别的节点。</li>
</ol>
<h3 id="notfound"><a href="#notfound" class="headerlink" title="notfound"></a>notfound</h3><p>notfound 的消息是对getdata消息的回复，该消息请求接收节点没有可用于发送的对象。 （预计节点不会传递不再存在于内存池或发送集中的历史事务，节点也可能从较旧的块中删除已用完的事务，使它们无法发送这些块。）</p>
<p>notfound消息的格式和最大大小限制与inv消息相同,只有消息的headers不同。</p>
<h3 id="mempool"><a href="#mempool" class="headerlink" title="mempool"></a>mempool</h3><p>mempool消息请求接收节点已验证为有效但尚未出现在块中的交易的TXID。 也就是说，在接收节点的内存池中的交易。 对mempool消息的响应是一个或多个包含 inventory 格式的TXID的inv消息。</p>
<p>当程序首次连接到网络时，发送mempool消息非常有用。 全节点可以使用它来快速收集网络上可用的大部分或全部未确认的交易; 这对试图收取交易费用的矿工尤其有用。 SPV客户端可以在发送mempool之前设置过滤器，以仅接收与该过滤器匹配的交易; 这允许最近开始的客户获得与其钱包有关的大部分或全部未确认的交易。</p>
<p>对mempool消息的inv响应充其量只是一个节点的网络视图 - 而不是网络上未经确认的交易的完整列表。以下是列表可能不完整的一些其他原因：</p>
<ul>
<li>在Bitcoin Core 0.9.0之前，对mempool消息的响应只有一个inv消息。 inv消息被限制为50,000个库存，所以具有大于50,000个条目的内存池的节点不会发送所有内容。 Bitcoin Core 的更新版本根据需要发送尽可能多的inv消息以引用其完整的内存池。</li>
<li>mempool消息当前不与filterload消息的BLOOM_UPDATE_ALL和BLOOM_UPDATE_P2PUBKEY_ONLY标志完全兼容。 Mempool交易不像块内交易那样排序，因此一个消耗输出的交易（tx2）可以出现在包含该输出的交易（tx1）之前，这意味着自动过滤器更新机制将不会运行，直到第二次出现的交易 tx1） - 缺少首次出现的交易（tx2）。 在<a href="https://github.com/bitcoin/bitcoin/issues/2381" target="_blank" rel="noopener">Bitcoin Core issue #2381</a>中已经提出，交易在被过滤器处理之前应该被排序。</li>
</ul>
<p><strong>以上是对 Data Messages 的描述，其关系图如下：</strong><br><img src="http://upload-images.jianshu.io/upload_images/6967649-10baa6a49bc59f03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="001.png"></p>
<h3 id="version"><a href="#version" class="headerlink" title="version:"></a>version:</h3><p>version 消息在连接开始时向接收节点提供关于发送节点的信息。在这两个节点交换 version 消息之前，不会接受其他消息。</p>
<p>当接收节点收到version消息之后，会回复给发送节点一个verack消息，同时把所有警告也反馈回去。但是在version消息的初始化未完成之前，是不会发送verack消息的。</p>
<p>发送端只能发送一次获取版本的命令，重复发送时，回应拒绝命令 (reject)。发送命令后，会把发送节点的地址信息添加到节点的地址管理器中。</p>
<p>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">72110100 ........................... Protocol version: 70002</span><br><span class="line">0100000000000000 ................... Services: NODE_NETWORK</span><br><span class="line">bc8f5e5400000000 ................... Epoch time: 1415483324</span><br><span class="line"></span><br><span class="line">0100000000000000 ................... Receiving node&apos;s services</span><br><span class="line">00000000000000000000ffffc61b6409 ... Receiving node&apos;s IPv6 address</span><br><span class="line">208d ............................... Receiving node&apos;s port number</span><br><span class="line"></span><br><span class="line">0100000000000000 ................... Transmitting node&apos;s services</span><br><span class="line">00000000000000000000ffffcb0071c0 ... Transmitting node&apos;s IPv6 address</span><br><span class="line">208d ............................... Transmitting node&apos;s port number</span><br><span class="line"></span><br><span class="line">128035cbc97953f8 ................... Nonce</span><br><span class="line"></span><br><span class="line">0f ................................. Bytes in user agent string: 15</span><br><span class="line">2f5361746f7368693a302e392e332f ..... User agent: /Satoshi:0.9.3/</span><br><span class="line"></span><br><span class="line">cf050500 ........................... Start height: 329167</span><br><span class="line">01 ................................. Relay flag: true</span><br></pre></td></tr></table></figure>
<h3 id="verack："><a href="#verack：" class="headerlink" title="verack："></a>verack：</h3><p>verack消息确认先前收到的版本消息，通知连接节点它可以开始发送其他消息。 接收到版本回应命令后，设置节点的接收版本。与此同时，设置接收版本号，节点的接收版本(nRecvVersion)、接收消息的报头流的版本号、接收消息数据流的版本号(nVersion)都要设置。</p>
<h3 id="adddr："><a href="#adddr：" class="headerlink" title="adddr："></a>adddr：</h3><p>addr（IP地址）消息用来表示网络上节点的连接信息。 每个想要接受传入连接的节点创建一个addr消息，提供其连接信息，然后将该消息发送给未经请求的节点，当接收端收到此命令后把接收到的地址添加到节点的地址管理器中，发送、接收的地址数量最多1000个。</p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>time</td>
<td>uint32</td>
<td>在协议版本31402中添加。采用Unix纪元格式的时间。通告自己IP地址的节点会将其设置为当前时间。通告他们连接的IP地址的节点将其设置为最后一次连接到该节点的时间。发送IP地址的节点不会改变时间。节点可以使用时间字段来避免传播旧的地址信息。恶意节点可能会改变时间，甚至可能会在未来进行设置。</td>
</tr>
<tr>
<td>8</td>
<td>services</td>
<td>uint64_t</td>
<td>节点在其版本消息中广播的服务信息。</td>
</tr>
<tr>
<td>16</td>
<td>IP address</td>
<td>char</td>
<td>IPv6地址采用大端字节顺序。 IPv4地址可以作为IPv4映射的IPv6地址提供</td>
</tr>
<tr>
<td>2</td>
<td>port</td>
<td>uint16_t</td>
<td>端口号以大端字节顺序排列。 请注意，为了寻找自己的伙伴，Bitcoin Core只会连接到具有非标准端口号的节点。 这是为了防止其他人尝试使用网络来破坏在其他端口上运行的非比特币服务。</td>
</tr>
</tbody>
</table>
<h3 id="Ping"><a href="#Ping" class="headerlink" title="Ping"></a>Ping</h3><p>ping消息有助于确认接收方仍处于连接状态(判断网络是否连通)。 如果在发送ping消息时遇到TCP / IP错误（例如连接超时），则发送节点可以假设接收节点已断开连接。 对ping消息的响应是pong消息。</p>
<p>在协议版本60000之前，ping消息没有 payload。从协议版本60001及所有更高版本开始，消息包含一个字段即nonce。</p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>8</td>
<td>nonce</td>
<td>uint64_t</td>
<td>如BIP31所述，在协议版本60001中添加。将随机数分配给ping消息。响应的pong消息将包括这个随机数以识别它正在回复的ping消息。</td>
</tr>
</tbody>
</table>
<p>ping消息的nonce字段，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0094102111e2af4d ... Nonce</span><br></pre></td></tr></table></figure>
<h3 id="pong"><a href="#pong" class="headerlink" title="pong"></a>pong</h3><p>pong消息回复ping消息，向<strong>pinging</strong>节点证明<strong>ponging</strong>节点仍然存在。默认情况下，Bitcoin Core将在20分钟内断开任何未响应ping消息的客户端。接收到pong命令后，更新节点的ping花费时间(nPingUsecTime)，所花费的时间为当前时间与节点的ping开始时间(nPingUsecStart)的差。</p>
<p>为了允许节点跟踪等待时间，pong的回复消息中所包含的nonce字段与ping消息的nonce是相同的。</p>
<p>pong消息的格式与ping消息相同;只有消息头不同。</p>
<h3 id="reject"><a href="#reject" class="headerlink" title="reject"></a>reject</h3><p>发生特殊情况时，reject 消息通知接收节点其先前消息之一已被拒绝。</p>
<p>特殊情况如下:</p>
<ul>
<li>重复发送获取版本信息的命令(”version”)。</li>
<li>发送端的版本号大于最大版本号(MIN_PEER_PROTO_VERSION = 209)。  </li>
<li>接收到DDoS攻击。</li>
<li>处理消息时发生异常(ProcessMessage)。</li>
</ul>
<p><em>发送拒绝命令时，带上参数，表示拒绝的原因。</em></p>
<table>
<thead>
<tr>
<th>Code</th>
<th>In Reply To</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x01</td>
<td>REJECT_MALFORMED</td>
<td>处理消息时发生异常(ProcessMessage)</td>
</tr>
<tr>
<td>0x10</td>
<td>REJECT_INVALID</td>
<td>块、交易信息无效</td>
</tr>
<tr>
<td>0x11</td>
<td>REJECT_OBSOLETE</td>
<td>块版本、发送端版本过期</td>
</tr>
<tr>
<td>0x12</td>
<td>REJECT_DUPLICATE</td>
<td>重复发送获取版本命令、交易信息</td>
</tr>
<tr>
<td>0x40</td>
<td>REJECT_NONSTANDARD</td>
<td>交易信息不标准</td>
</tr>
<tr>
<td>0x41</td>
<td>REJECT_DUST</td>
<td>无</td>
</tr>
<tr>
<td>0x42</td>
<td>REJECT_INSUFFICIENTFEE</td>
<td>交易费不足</td>
</tr>
<tr>
<td>0x43</td>
<td>REJECT_CHECKPOINT</td>
<td>与校验点有关的错误</td>
</tr>
</tbody>
</table>
<h3 id="SendHeaders"><a href="#SendHeaders" class="headerlink" title="SendHeaders"></a>SendHeaders</h3><p>sendheaders消息告诉接收方使用 headers 消息而不是inv消息发送新的块通告，具体可参照 bip130 。</p>
<h3 id="GetAddr"><a href="#GetAddr" class="headerlink" title="GetAddr"></a>GetAddr</h3><p>getaddr消息请求来自接收节点的addr消息，最好是具有大量其他接收节点的IP地址的消息。 发送节点可以使用这些IP地址来快速更新其可用节点的数据库，而不是等待未经请求的addr消息随时间到达。</p>
<p>接收到getaddr命令后把节点的地址管理器中的地址返回给发送端。先清空源节点的发送地址数组(vAddrToSend)。再把节点的IP地址管理器 (addrman)中的地址(CAddress)发送给源节点。</p>
<h3 id="FeeFilter"><a href="#FeeFilter" class="headerlink" title="FeeFilter"></a>FeeFilter</h3><p>FeeFilter消息是对接收方的请求，不将任何交易inv消息转发给发送方，其中交易费率低于feefilter消息中指定的费率。</p>
<p>在Bitcoin Core 0.12.0引入mempool限制之后，feefilter在Bitcoin Core 0.13.0中引入。 Mempool限制功能可以防止费用较低的交易的攻击，并且不会将其纳入开采块中。 feefilter消息告诉其他节点，如果你的费率低于我预先设置的费率，那你的这个交易是不允许进入我的mempool的，同时，这些节点就没必要继续把低于该费率的交易的inv消息转达给该节点。</p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>8</td>
<td>feerate</td>
<td>uint64_t</td>
<td>费用率（以每千字节为satoshis）低于该费率，交易不应传递给其它节点。</td>
</tr>
</tbody>
</table>
<p>接收方可以选择不过滤这笔交易，直接忽略该消息。</p>
<p>FeeFilter与bloom过滤器相加。如果SPV客户端加载bloom过滤器并发送FeeFilter消息，则只有通过两个过滤器才能转发交易。</p>
<p>但请注意，feefilter对块传播或对getdata消息的响应没有影响。 例如，如果一个节点通过发送一个包含inv类型MSG_FILTERED_BLOCK的getdata消息来请求一个merkleblock，并且它先前已经向该节点发送了一个feefilter，那么即使他们低于feefilter的费率，该节点也应该响应一个包含所有匹配bloom过滤器的交易的merkleblock。</p>
<p>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7cbd000000000000 ... satoshis per kilobyte: 48,508</span><br></pre></td></tr></table></figure>
<h3 id="FilterAdd"><a href="#FilterAdd" class="headerlink" title="FilterAdd"></a>FilterAdd</h3><p>filteradd消息告诉接收方将单个元素添加到先前设置的布隆过滤器，例如新的公共hash。 该元素直接发送给接收方; 然后其它节点使用在过滤器加载消息中设置的参数来将该元素添加到布隆过滤器。</p>
<p>由于该元素直接发送到接收方，因此elem不会产生歧义，也不会出现布隆过滤器提供的似是而非的隐私。希望保持更高隐私性的客户端应自行重新计算布隆过滤器，并使用重新计算的布隆过滤器发送新的过滤器负载消息。</p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Varies</td>
<td>element bytes</td>
<td>compactSize uint</td>
<td>下列元素字段中的字节数。</td>
</tr>
<tr>
<td>Varies</td>
<td>element</td>
<td>uint8_t[]</td>
<td>要添加到当前过滤器的元素。最大为520个字节，这是在pubkey或签名脚本中可以压入堆栈的元素的最大大小。元素必须以它们在原始交易中出现时使用的字节顺序发送; 例如，hash应以内部字节顺序发送。</td>
</tr>
</tbody>
</table>
<p><strong>注意：除非先前使用的filterload消息设置了过滤器，否则节点将不接受filteradd消息。</strong></p>
<p>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">20 ................................. Element bytes: 32</span><br><span class="line">fdacf9b3eb077412e7a968d2e4f11b9a</span><br><span class="line">9dee312d666187ed77ee7d26af16cb0b ... Element (A TXID)</span><br></pre></td></tr></table></figure>
<h3 id="FilterClear"><a href="#FilterClear" class="headerlink" title="FilterClear"></a>FilterClear</h3><p>filterclear消息告诉接收方删除先前设置的bloom过滤器。这也消除了将版本消息中的转发字段设置为0的效果，允许未经过滤的访问广播新交易的inv消息。</p>
<p>Bitcoin Core在替换过滤器加载filterload之前不需要filterclear消息。它也不需要filterclear消息之前的filterload消息。</p>
<h3 id="FilterLoad"><a href="#FilterLoad" class="headerlink" title="FilterLoad"></a>FilterLoad</h3><p>filterload消息告诉接收方需要过滤所有转发的交易，并通过提供的过滤器请求merkle块。 这允许客户接收与其钱包相关的交易。</p>
<table>
<thead>
<tr>
<th>bytes</th>
<th>name</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Varies</td>
<td>nFilterBytes</td>
<td>compactSize uint</td>
<td>以下过滤器位字段中的字节数。</td>
</tr>
<tr>
<td>Varies</td>
<td>filter</td>
<td>uint8_t[]</td>
<td>任意字节对齐大小的位字段。最大大小是36,000字节。</td>
</tr>
<tr>
<td>4</td>
<td>nHashFuncs</td>
<td>uint32_t</td>
<td>在此过滤器中使用的hash函数的数量。该字段中允许的最大值为50。</td>
</tr>
<tr>
<td>4</td>
<td>nTweak</td>
<td>uint32_t</td>
<td>一个任意值，用于添加到布隆过滤器使用的哈希函数中的种子值。</td>
</tr>
<tr>
<td>1</td>
<td>nFlags</td>
<td>uint8_t</td>
<td>一组控制与匹配的pubkey脚本相对应的outpoint的标志被添加到过滤器中。请参阅下面的更新布隆过滤器小节中的表格。</td>
</tr>
</tbody>
</table>
<p>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">02 ......... Filter bytes: 2</span><br><span class="line">b50f ....... Filter: 1010 1101 1111 0000</span><br><span class="line">0b000000 ... nHashFuncs: 11</span><br><span class="line">00000000 ... nTweak: 0/none</span><br><span class="line">00 ......... nFlags: BLOOM_UPDATE_NONE</span><br></pre></td></tr></table></figure>
<h3 id="sendcmpct-and-cmpctblock、getblocktxn、blocktxn参照BIP152"><a href="#sendcmpct-and-cmpctblock、getblocktxn、blocktxn参照BIP152" class="headerlink" title="sendcmpct and cmpctblock、getblocktxn、blocktxn参照BIP152."></a>sendcmpct and cmpctblock、getblocktxn、blocktxn参照BIP152.</h3><p><strong>以上是对Control Messages的描述，其关系如下：</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/6967649-4793d9bd4f6631cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Control Messages"></p>
<p>下表列出了一些值得注意的P2P网络协议版本，其中最新版本列在第一位：</p>
<table>
<thead>
<tr>
<th>version</th>
<th>Initial Release</th>
<th>Major Changes</th>
</tr>
</thead>
<tbody>
<tr>
<td>70015</td>
<td><a href="https://bitcoin.org/en/release/v0.13.2" target="_blank" rel="noopener">Bitcoin Core 0.13.2</a> (Jan 2017)</td>
<td>v0.14.0中对无效压缩 <a href="https://bitcoin.org/en/glossary/block" title="One or more transactions prefaced by a block header and protected by proof of work. Blocks are the data stored on the block chain." target="_blank" rel="noopener">blocks</a> 的新禁用行为<a href="https://github.com/bitcoin/bitcoin/pull/9026" target="_blank" rel="noopener">#9026</a>, 在<a href="https://github.com/bitcoin/bitcoin/pull/9048" target="_blank" rel="noopener">#9048</a>中回退到v0.13.2 .</td>
</tr>
<tr>
<td>70014</td>
<td><a href="https://bitcoin.org/en/release/v0.13.0" target="_blank" rel="noopener">Bitcoin Core 0.13.0</a> (Aug 2016)</td>
<td><a href="https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki" target="_blank" rel="noopener">BIP152</a>: 增加了 <code>sendcmpct</code>, <code>cmpctblock</code>, <code>getblocktxn</code>, <code>blocktxn</code> 消息类型；给 <a href="https://bitcoin.org/en/developer-reference#getdata" title="A P2P protocol message used to request one or more transactions, blocks, or merkle blocks" target="_blank" rel="noopener"><code>getdata</code>message</a>.增加了<code>MSG_CMPCT_BLOCK</code> <a href="https://bitcoin.org/en/glossary/inventory" title="A data type identifier and a hash; used to identify transactions and blocks available for download through the Bitcoin P2P network." target="_blank" rel="noopener">inventory</a> 类型</td>
</tr>
<tr>
<td>70013</td>
<td><a href="https://bitcoin.org/en/release/v0.13.0" target="_blank" rel="noopener">Bitcoin Core 0.13.0</a> (Aug 2016)</td>
<td><a href="https://github.com/bitcoin/bips/blob/master/bip-0133.mediawiki" target="_blank" rel="noopener">BIP133</a>: 增加了 <a href="https://bitcoin.org/en/developer-reference#feefilter" title="The P2P network message which requests the receiving peer not relay any transactions below the specified fee rate" target="_blank" rel="noopener"><code>feefilter</code> message</a>.移除了 <a href="https://bitcoin.org/en/developer-reference#alert" title="The P2P network message which sends alerts in case of major software problems." target="_blank" rel="noopener"><code>alert</code> message</a> 系统. 具体参照 <a href="https://bitcoin.org/en/alert/2016-11-01-alert-retirement" target="_blank" rel="noopener">Alert System Retirement</a></td>
</tr>
<tr>
<td>70012</td>
<td><a href="https://bitcoin.org/en/release/v0.12.0" target="_blank" rel="noopener">Bitcoin Core 0.12.0</a> (Feb 2016)</td>
<td><a href="https://github.com/bitcoin/bips/blob/master/bip-0130.mediawiki" target="_blank" rel="noopener">BIP130</a>: 增加了 <a href="https://bitcoin.org/en/developer-reference#sendheaders" title="A P2P network message used to request new blocks be announced through headers messages rather than inv messages" target="_blank" rel="noopener"><code>sendheaders</code> message</a>.</td>
</tr>
<tr>
<td>70011</td>
<td><a href="https://bitcoin.org/en/release/v0.12.0" target="_blank" rel="noopener">Bitcoin Core 0.12.0</a> (Feb 2016)</td>
<td><a href="https://github.com/bitcoin/bips/blob/master/bip-0111.mediawiki" target="_blank" rel="noopener">BIP111</a>: 在包含此版本后，<code>filter*</code> 消息在没有NODE_BLOOM的情况下被禁用。</td>
</tr>
<tr>
<td>70002</td>
<td><a href="https://bitcoin.org/en/release/v0.7.0" target="_blank" rel="noopener">Bitcoin Core 0.7.0</a> (Sep 2012)</td>
<td><a href="https://github.com/bitcoin/bips/blob/master/bip-0035.mediawiki" target="_blank" rel="noopener">BIP35</a>: 增加了 <a href="https://bitcoin.org/en/developer-reference#mempool" title="A P2P protocol message used to request one or more inv messages with currently-unconfirmed transactions" target="_blank" rel="noopener"><code>mempool</code> message</a>. 扩展了 <a href="https://bitcoin.org/en/developer-reference#getdata" title="A P2P protocol message used to request one or more transactions, blocks, or merkle blocks" target="_blank" rel="noopener"><code>getdata</code> message</a> 允许下载内存池中的交易</td>
</tr>
<tr>
<td>60001</td>
<td><a href="https://bitcoin.org/en/release/v0.6.1" target="_blank" rel="noopener">Bitcoin Core 0.6.1</a> (May 2012)</td>
<td><a href="https://github.com/bitcoin/bips/blob/master/bip-0031.mediawiki" target="_blank" rel="noopener">BIP31</a>: 增加nonce字段为 <a href="https://bitcoin.org/en/developer-reference#ping" title="A P2P network message used to see if the remote host is still connected" target="_blank" rel="noopener"><code>ping</code> message</a> 、增加了 <a href="https://bitcoin.org/en/developer-reference#pong" title="A P2P network message used to reply to a P2P network ping message" target="_blank" rel="noopener"><code>pong</code> message</a></td>
</tr>
<tr>
<td>31800</td>
<td><a href="https://github.com/bitcoin/bitcoin/commit/82201801336f64ee77851b9eaab9383ee4e442f0" target="_blank" rel="noopener">Bitcoin Core 0.3.18</a> (Dec 2010)</td>
<td>增加了 <a href="https://bitcoin.org/en/developer-reference#getheaders" title="A P2P protocol message used to request a range of block headers" target="_blank" rel="noopener"><code>getheaders</code> message</a> 和 <a href="https://bitcoin.org/en/developer-reference#headers" title="A P2P protocol message containing one or more block headers" target="_blank" rel="noopener"><code>headers</code> message</a>.</td>
</tr>
<tr>
<td>31402</td>
<td><a href="https://github.com/bitcoin/bitcoin/commit/c891967b6fcab2e8dc4ce0c787312b36c07efa4d" target="_blank" rel="noopener">Bitcoin Core 0.3.15</a> (Oct 2010)</td>
<td>给 <a href="https://bitcoin.org/en/developer-reference#addr" title="The P2P network message which relays IP addresses and port numbers of active nodes to other nodes and clients, allowing decentralized peer discovery." target="_blank" rel="noopener"><code>addr</code> message</a>添加时间字段</td>
</tr>
<tr>
<td>311</td>
<td><a href="https://github.com/bitcoin/bitcoin/commit/343328c6b8db85e58a1feea85f0d10e62967fa19" target="_blank" rel="noopener">Bitcoin Core 0.3.11</a> (Aug 2010)</td>
<td>增加了 <a href="https://bitcoin.org/en/developer-reference#alert" title="The P2P network message which sends alerts in case of major software problems." target="_blank" rel="noopener"><code>alert</code> message</a>.</td>
</tr>
<tr>
<td>209</td>
<td><a href="https://github.com/bitcoin/bitcoin/commit/42605ce8bcc9bd01b86491c74fee14de77960868" target="_blank" rel="noopener">Bitcoin Core 0.2.9</a> (May 2010)</td>
<td>给 <a href="https://bitcoin.org/en/glossary/message-header" title="The four header fields prefixed to all messages on the Bitcoin P2P network." target="_blank" rel="noopener">message headers</a>增加了时间字段, 增加了 <a href="https://bitcoin.org/en/developer-reference#verack" title="A P2P network message sent in reply to a version message to confirm a connection has been established" target="_blank" rel="noopener"><code>verack</code> message</a>, 并且增加了开始的 <a href="https://bitcoin.org/en/glossary/block-height" title="The number of blocks preceding a particular block on a block chain. For example, the genesis block has a height of zero because zero block preceded it." target="_blank" rel="noopener">height</a> 给 <a href="https://bitcoin.org/en/developer-reference#version" title="A P2P network message sent at the begining of a connection to allow protocol version negotiation" target="_blank" rel="noopener"><code>version</code> message</a>.</td>
</tr>
<tr>
<td>106</td>
<td><a href="https://github.com/bitcoin/bitcoin/commit/cc0b4c3b62367a2aebe5fc1f4d0ed4b97e9c2ac9" target="_blank" rel="noopener">Bitcoin Core 0.1.6</a> (Oct 2009)</td>
<td>给发送端的<a href="https://bitcoin.org/en/developer-reference#version" title="A P2P network message sent at the begining of a connection to allow protocol version negotiation" target="_blank" rel="noopener"><code>version</code> message</a>添加了IP地址字段，随机数和用户代理（subVer）</td>
</tr>
</tbody>
</table>
<hr>
<p>本文由 <code>copernicus 团队 冉小龙</code> 分析编写，转载无需授权！</p>

        </div>
        <div class="post-reply">
            
                <!-- 来必力City版安装代码 -->
                <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTE4Ni81NzUz">
                    <script type="text/javascript">
                        (function(d, s) {
                            var j, e = d.getElementsByTagName(s)[0];

                            if (typeof LivereTower === 'function') { return; }

                            j = d.createElement(s);
                            j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                            j.async = true;

                            e.parentNode.insertBefore(j, e);
                        })(document, 'script');
                    </script>
                    <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
                </div>
                <!-- City版安装代码已完成 -->
            
            
        </div>
    </div>
</section>
<script>
    // 获取第一张图, 用以当封面背景图
    var img = document.querySelectorAll('img')[1]

    if (img) {
        var header_box = document.querySelector('#header_box')
        header_box.style.backgroundImage = 'url('+ img.src +')'
    }
</script>
      </div>
  </div>
  <style>
  #footer {
    min-height: 10vh;
    background: black;
    color: #fff;
  }

  #footer a {
    color: #e1e1e1;
  }
</style>
<footer id="footer" class="has-text-centered is-flex center">
  <div class="container has-padding">
    <div>
      <div>
        <!--请您保留作者署名, 主题制作来之不易-->
        Theme by <a href="http://haojen.github.io/">Haojen Ma</a>
        <br>
        Copyright © Copernicus 2018
        <br>
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      </div>
    </div>
  </div>
</footer>

<script src="/js/search_core.js"></script>
<script src="/js/script.js"></script>

</body>
</html>